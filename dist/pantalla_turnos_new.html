<?php
require '../elementos/redirecciones.php';
$conn = loadConexion(); // âœ… Crea la conexiÃ³n
loadLogIn();


$clienteLogueado = false;
$nombreCliente = "";

if (isset($_SESSION["usuario"]) && $_SESSION["rol"] === "cliente") {
    $clienteLogueado = true;
    $nombreCliente = $_SESSION["usuario"];
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pantalla de Espera</title>
<link rel="stylesheet" href="../css/components/pantalla_espera.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<title>Sistema de Turnos</title>
<link rel="stylesheet" href="pantalla_turnos_new.css">
</head>
<body>

<?php

loadHeader();
?>

<div class="texto">TOMA TU TURNO</div>
.btn-cerrar:hover {
    background-color: #c9302c;
    transform: translateY(-2px);
}
</style>
</head>
<body>
<header>

    
    <div class="logo">
        <img src="/img/img.Logo_blanco-Photoroom.png" width="70"/>
    </div>
    <div class="user-panel" style="display:flex; align-items:center; gap:8px;">
        <span style="display:flex; align-items:center; gap:5px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd"/>
            </svg>
            <?= $_SESSION['rol'] ?? 'Empleado' ?>
        </span>

        <?php if(isset($_SESSION['rol']) && $_SESSION['rol'] === 'empleado'): ?>
            <a href="./admin/" class="btn-regresar" title="Regresar"></a>
        <?php endif; ?>

        <form method="post" style="margin:0;">
            <button type="submit" name="cerrar_sesion" class="btn-cerrar" title="Cerrar sesiÃ³n"></button>
        </form>

        <div class="time">
            <?php
                date_default_timezone_set('America/Mexico_City');
                echo date('h:i a') . "<br>" . date('d \d\e F Y');
            ?>
        </div>
    </div>
</header>

<div class="contenedor">
  <div class="circulo rojo"></div>
  <div class="circulo azul"></div>
  <div class="circulo verde"></div>

  <!-- BotÃ³n CLIENTE -->
  <?php if ($clienteLogueado): ?>
      <button class="boton izquierda" onclick="abrirModalCliente()">CLIENTE</button>
  <?php else: ?>
      <button class="boton izquierda" onclick="window.location.href='/pantallas/login_Cliente.php'">CLIENTE</button>
  <?php endif; ?>

  <!-- BotÃ³n VISITANTE -->
  <button class="boton derecha" onclick="abrirModalVisitante()">VISITANTE</button>
</div>

<!-- Modal -->
<div class="overlay" id="modal">
  <div class="modal">
    <div class="turno-modal">
      <button class="cerrar">âœ–</button>
      <img src="/img/img.Logo_blanco-Photoroom.png" alt="Logo" class="imagen">
      <div class="texto">ClickMatic</div>
      <div class="rectangulo">Turno</div>
      <div class="rectangulo1" id="turnoModal">...</div>
      <div class="rectangulo4" id="nombreModal">...</div>
      <div class="texto1">TOMA TURNO |</div>
    </div>
  </div>
</div>

<script>
const overlay = document.querySelector('.overlay');
const modal = document.querySelector('.modal');
const cerrar = document.querySelector('.cerrar');

cerrar.addEventListener('click', cerrarModal);
overlay.addEventListener('click', cerrarModal);

// Generar turno visitante
async function abrirModalVisitante() {
    try {
        const response = await fetch("generar_turno.php?tipo=visitante");
        const turno = await response.text();
        document.getElementById("turnoModal").textContent = turno;
        document.getElementById("nombreModal").textContent = "Visitante";
        overlay.classList.add('active');
        modal.classList.add('active');
    } catch (error) {
        console.error("Error al generar turno visitante:", error);
    }
}

// Generar turno cliente logueado
async function abrirModalCliente() {
    try {
        const response = await fetch("generar_turno.php?tipo=cliente");
        const turno = await response.text();
        document.getElementById("turnoModal").textContent = turno;
        document.getElementById("nombreModal").textContent = "<?php echo htmlspecialchars($nombreCliente); ?>";
        overlay.classList.add('active');
        modal.classList.add('active');

        // ðŸ”¹ Destruir sesiÃ³n al sacar el turno (para que otro cliente pueda iniciar)
        await fetch("logout_cliente.php");
    } catch (error) {
        console.error("Error al generar turno cliente:", error);
    }
}

function cerrarModal() {
    modal.classList.add('closing');
    overlay.classList.remove('active');
    setTimeout(() => {
        modal.classList.remove('active', 'closing');
    }, 600);
}
</script>

    <div class="grupo">
        <div class="rectangulo">
            Turno
        </div>
        <div class="rectangulo">
            Modulo
        </div>
    </div>

    <div class="rectangulo3">
        Camila Perez
    </div>

<footer>
    ClickMatic
</footer>
</body>
</html>
